trigger:
- main

pool:
 name: DockerBuildAgents

steps:
- script: |
    echo Run instrumented tests
    docker --version
    echo Kill all running containers if existing
    docker container kill $(docker ps -q)
    echo Run test inside new container
    docker run --privileged --cpus="3" --memory="12g" -v "$PWD":/home/gradle/ -w /home/gradle/ authclient.azurecr.io/samples/dbi-instrumented-api30 sh scripts/run-instrumented-tests.sh
  displayName: 'Run instrumented tests'
- script: |
    echo claim ownership of any files generated by docker build and test
    sudo chown -R $USER:$USER ~/myagent/_work
    env
  displayName: 'Cleanup'
